<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <title>Figma Schema Capture Utility</title>
    <style>
        * {
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            max-width: 900px;
            margin: 0 auto;
            padding: 40px 20px;
            background: #1a1a2e;
            color: #eee;
        }

        h1 {
            color: #a855f7;
            margin-bottom: 10px;
        }

        .subtitle {
            color: #888;
            margin-bottom: 30px;
        }

        .step {
            background: #252542;
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 20px;
            border-left: 4px solid #a855f7;
        }

        .step-number {
            background: #a855f7;
            color: white;
            width: 28px;
            height: 28px;
            border-radius: 50%;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            margin-right: 10px;
        }

        .step h3 {
            display: inline;
        }

        button {
            background: linear-gradient(135deg, #a855f7, #6366f1);
            color: white;
            border: none;
            padding: 14px 28px;
            border-radius: 8px;
            font-size: 16px;
            cursor: pointer;
            margin: 10px 5px 10px 0;
        }

        button:hover {
            opacity: 0.9;
        }

        button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        #pasteArea {
            width: 100%;
            min-height: 120px;
            background: #16162a;
            border: 2px dashed #444;
            border-radius: 8px;
            padding: 20px;
            color: #888;
            font-size: 14px;
            resize: vertical;
            margin: 15px 0;
        }

        #pasteArea:focus {
            border-color: #a855f7;
            outline: none;
        }

        #pasteArea.has-data {
            border-color: #10b981;
            border-style: solid;
            color: #10b981;
        }

        #output {
            background: #0d0d1a;
            border-radius: 8px;
            padding: 15px;
            font-family: 'Monaco', 'Consolas', monospace;
            font-size: 12px;
            white-space: pre-wrap;
            word-break: break-all;
            max-height: 500px;
            overflow-y: auto;
            margin-top: 15px;
            display: none;
        }

        .success {
            color: #10b981;
        }

        .error {
            color: #ef4444;
        }

        .info {
            color: #3b82f6;
        }

        .warning {
            color: #f59e0b;
        }

        .copy-btn {
            background: #10b981;
        }

        kbd {
            background: #333;
            padding: 2px 6px;
            border-radius: 4px;
            font-family: monospace;
        }

        details {
            margin: 10px 0;
        }

        summary {
            cursor: pointer;
            color: #a855f7;
        }
    </style>
</head>

<body>
    <h1>üîß Figma Schema Capture Utility</h1>
    <p class="subtitle">‡πÉ‡∏ä‡πâ‡∏´‡∏ô‡πâ‡∏≤‡∏ô‡∏µ‡πâ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏î‡∏∂‡∏á Schema ‡∏à‡∏≤‡∏Å Figma Clipboard ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÉ‡∏ä‡πâ‡πÉ‡∏ô Time AI Extension</p>

    <div class="step">
        <span class="step-number">1</span>
        <h3>‡πÄ‡∏õ‡∏¥‡∏î Figma ‡πÅ‡∏•‡∏∞‡πÄ‡∏•‡∏∑‡∏≠‡∏Å Element</h3>
        <p>‡πÄ‡∏õ‡∏¥‡∏î Figma ‡πÅ‡∏•‡πâ‡∏ß‡πÄ‡∏•‡∏∑‡∏≠‡∏Å Element ‡∏≠‡∏∞‡πÑ‡∏£‡∏Å‡πá‡πÑ‡∏î‡πâ (Frame, Rectangle, Text ‡∏Ø‡∏•‡∏Ø)</p>
    </div>

    <div class="step">
        <span class="step-number">2</span>
        <h3>Copy Element (Cmd+C / Ctrl+C)</h3>
        <p>‡∏Å‡∏î <kbd>Cmd+C</kbd> (Mac) ‡∏´‡∏£‡∏∑‡∏≠ <kbd>Ctrl+C</kbd> (Windows) ‡πÄ‡∏û‡∏∑‡πà‡∏≠ Copy element</p>
    </div>

    <div class="step">
        <span class="step-number">3</span>
        <h3>Paste HTML ‡∏ó‡∏µ‡πà‡∏ô‡∏µ‡πà</h3>
        <p>‡∏Ñ‡∏•‡∏¥‡∏Å‡πÉ‡∏ô‡∏Å‡∏•‡πà‡∏≠‡∏á‡∏î‡πâ‡∏≤‡∏ô‡∏•‡πà‡∏≤‡∏á ‡πÅ‡∏•‡πâ‡∏ß‡∏Å‡∏î <kbd>Cmd+V</kbd> / <kbd>Ctrl+V</kbd></p>
        <textarea id="pasteArea" placeholder="üìã ‡∏Ñ‡∏•‡∏¥‡∏Å‡∏ó‡∏µ‡πà‡∏ô‡∏µ‡πà‡πÅ‡∏•‡πâ‡∏ß Paste (Cmd+V)"></textarea>
        <p class="info" id="status"></p>
    </div>

    <div class="step">
        <span class="step-number">4</span>
        <h3>‡∏î‡∏π Raw HTML (Debug)</h3>
        <button id="showRawBtn">Show Raw HTML</button>
        <button id="parseBtn">Parse Figma Data</button>
        <button id="copySchemaBtn" class="copy-btn" style="display:none;">üìã Copy Schema JSON</button>
        <div id="output"></div>
    </div>

    <script>
        const pasteArea = document.getElementById('pasteArea');
        const showRawBtn = document.getElementById('showRawBtn');
        const parseBtn = document.getElementById('parseBtn');
        const copySchemaBtn = document.getElementById('copySchemaBtn');
        const output = document.getElementById('output');
        const status = document.getElementById('status');

        let rawHTML = '';

        // Handle paste event
        pasteArea.addEventListener('paste', (e) => {
            e.preventDefault();

            // Get HTML from clipboard
            const htmlData = e.clipboardData.getData('text/html');
            const textData = e.clipboardData.getData('text/plain');

            console.log('Paste event triggered!');
            console.log('HTML length:', htmlData?.length);
            console.log('Text length:', textData?.length);

            if (htmlData) {
                rawHTML = htmlData;

                if (htmlData.includes('figmeta') || htmlData.includes('figma')) {
                    pasteArea.value = '‚úÖ Figma data received! (' + htmlData.length + ' characters)';
                    pasteArea.classList.add('has-data');
                    status.innerHTML = '<span class="success">‡∏û‡∏ö Figma data! ‡∏Å‡∏î‡∏õ‡∏∏‡πà‡∏° Parse Figma Data ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏î‡∏π‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î</span>';
                } else {
                    pasteArea.value = '‚ö†Ô∏è ‡πÑ‡∏î‡πâ‡∏£‡∏±‡∏ö HTML ‡πÅ‡∏ï‡πà‡πÑ‡∏°‡πà‡πÉ‡∏ä‡πà Figma format (' + htmlData.length + ' chars)';
                    status.innerHTML = '<span class="warning">‡πÑ‡∏°‡πà‡∏û‡∏ö figmeta tag - ‡∏•‡∏≠‡∏á Copy ‡∏à‡∏≤‡∏Å Figma ‡∏≠‡∏µ‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á</span>';
                }
            } else if (textData) {
                pasteArea.value = textData;
                rawHTML = textData;
                status.innerHTML = '<span class="warning">‡πÑ‡∏î‡πâ‡∏£‡∏±‡∏ö Plain text ‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô (‡πÑ‡∏°‡πà‡πÉ‡∏ä‡πà HTML)</span>';
            } else {
                status.innerHTML = '<span class="error">‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡∏£‡∏±‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏≤‡∏Å clipboard</span>';
            }
        });

        // Show raw HTML
        showRawBtn.addEventListener('click', () => {
            output.style.display = 'block';
            if (rawHTML) {
                // Escape HTML for display
                const escaped = rawHTML.replace(/</g, '&lt;').replace(/>/g, '&gt;');
                output.innerHTML = `<strong>Raw HTML (${rawHTML.length} chars):</strong>\n\n${escaped}`;
            } else {
                output.innerHTML = '<span class="error">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ HTML data ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤ Paste ‡∏Å‡πà‡∏≠‡∏ô</span>';
            }
        });

        // Parse Figma data
        parseBtn.addEventListener('click', () => {
            output.style.display = 'block';

            if (!rawHTML) {
                output.innerHTML = '<span class="error">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ data ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤ Paste ‡∏Å‡πà‡∏≠‡∏ô</span>';
                return;
            }

            try {
                // Extract figmeta - using RegExp constructor to avoid IDE parser issues
                const metaRegex1 = new RegExp('<!--\\(figmeta\\)(.*?)\\(/figmeta\\)-->', 's');
                const metaRegex2 = new RegExp('data-metadata="<!--\\(figmeta\\)(.*?)\\(/figmeta\\)-->"', 's');
                const metaMatch = rawHTML.match(metaRegex1) || rawHTML.match(metaRegex2);

                // Extract figma buffer
                const bufferRegex1 = new RegExp('<!--\\(figma\\)(.*?)\\(/figma\\)-->', 's');
                const bufferRegex2 = new RegExp('data-buffer="<!--\\(figma\\)(.*?)\\(/figma\\)-->"', 's');
                const bufferMatch = rawHTML.match(bufferRegex1) || rawHTML.match(bufferRegex2);

                let metaInfo = 'Not found';
                let bufferInfo = 'Not found';

                if (metaMatch && metaMatch[1]) {
                    try {
                        const metaB64 = metaMatch[1];
                        const metaJSON = atob(metaB64);
                        const meta = JSON.parse(metaJSON);
                        metaInfo = JSON.stringify(meta, null, 2);
                        window._capturedMeta = meta;
                    } catch (e) {
                        metaInfo = 'Error decoding: ' + e.message;
                    }
                }

                if (bufferMatch && bufferMatch[1]) {
                    const bufferB64 = bufferMatch[1];
                    bufferInfo = `Base64 data found (${bufferB64.length} chars)\nFirst 100 chars: ${bufferB64.substring(0, 100)}...`;
                    window._capturedBuffer = bufferB64;

                    // Try to decode first bytes
                    try {
                        const binary = atob(bufferB64);
                        const firstBytes = binary.substring(0, 20);
                        bufferInfo += `\n\nFirst bytes (decoded): ${firstBytes}`;
                    } catch (e) {
                        bufferInfo += '\n\nCould not decode base64';
                    }
                }

                output.innerHTML = `
<span class="success">‚úÖ Parsed Figma clipboard data!</span>

<strong>üìä Meta (figmeta):</strong>
${metaInfo}

<strong>üì¶ Buffer (figma):</strong>
${bufferInfo}

<strong>üí° Next Step:</strong>
Copy this data and send to developer to integrate into extension.
`;

                copySchemaBtn.style.display = 'inline-block';

            } catch (err) {
                output.innerHTML = `<span class="error">‚ùå Parse error: ${err.message}</span>\n\n${err.stack}`;
            }
        });

        // Copy captured data
        copySchemaBtn.addEventListener('click', () => {
            const data = {
                meta: window._capturedMeta || null,
                bufferB64: window._capturedBuffer || null,
                rawHTML: rawHTML
            };
            navigator.clipboard.writeText(JSON.stringify(data, null, 2));
            copySchemaBtn.textContent = '‚úÖ Copied!';
            setTimeout(() => copySchemaBtn.textContent = 'üìã Copy Schema JSON', 2000);
        });

        // Also log when textarea gets focus
        pasteArea.addEventListener('focus', () => {
            console.log('Paste area focused');
        });
    </script>
</body>

</html>